{
  "title": "Tutorial - ErgoDocs",
  "source_url": "https://docs.ergoplatform.com/dev/wallet/payments/ergopay/ep-tutorial/",
  "summary": "This tutorial will focus on implementing the backend server-side for ErgoPay, building and preparing transactions. We\u00e2\u0080\u0099ll use Spring Boot to implement a simple ErgoPay REST API. Spring has the following benefits why we\u00e2\u0080\u0099ve chosen it here: It\u00e2\u0080\u0099s JVM-based, and ergo-appkit, one of Ergo\u00e2\u0080\u0099s SDKs, is also JVM-based. It\u00e2\u0080\u0099s easy and boilerplate-free, tons of tutorials and information is available, it runs on your local machine with ease. There are both free and paid services to get the application deployed to the public.",
  "keywords": [
    "tutorial",
    "server",
    "side",
    "ergopay",
    "building",
    "transaction",
    "we\u00e2\u0080\u0099ll",
    "spring",
    "boot",
    "rest",
    "benefit",
    "we\u00e2\u0080\u0099ve",
    "it\u00e2\u0080\u0099s",
    "ergo",
    "appkit",
    "ergo\u00e2\u0080\u0099s",
    "boilerplate",
    "information",
    "machine",
    "ease",
    "service",
    "application",
    "public",
    "programming",
    "language",
    "framework",
    "concept",
    "implementation",
    "dapp",
    "code",
    "showcase",
    "course",
    "choice",
    "you\u00e2\u0080\u0099ll",
    "java",
    "development",
    "openjdk",
    "linux",
    "adoptium",
    "windows",
    "project",
    "initializr",
    "form",
    "\u00e2\u0080\u009cspring",
    "web\u00e2\u0080\u009d",
    "dependency",
    "eclipse",
    "\u00e2\u0080\u009cgradle",
    "project\u00e2\u0080\u009d.",
    "download",
    "gradle",
    "print",
    "http://localhost:8080/",
    "ctrl",
    "quick",
    "start",
    "hello",
    "world",
    "endpoint",
    "time",
    "request",
    "method",
    "\u00e2\u0080\u009cergopayresponse\u00e2\u0080\u009d",
    "response",
    "body",
    "ergopayresponse",
    "json",
    "data",
    "interchange",
    "format",
    "wallet",
    "improvement",
    "proposal",
    "datum",
    "type",
    "object",
    "file",
    "class",
    "return",
    "restcontroller",
    "serialization",
    "error",
    "message",
    "user",
    "http://localhost:8080",
    "browser",
    "device",
    "network",
    "\u00e2\u0080\u009chttp(s)\u00e2\u0080\u009d",
    "prefix",
    "\u00e2\u0080\u009cergopay\u00e2\u0080\u009d",
    "case",
    "\u00e2\u0080\u009clocalhost\u00e2\u0080\u009d",
    "address",
    "computer",
    "ergopay://192.168.0.1:8080",
    "example",
    "spice",
    "field",
    "\u00e2\u0080\u009creducedtx\u00e2\u0080\u009d.",
    "\u00e2\u0080\u009creduce\u00e2\u0080\u009d",
    "line",
    "section",
    "starter",
    "declaration",
    "helper",
    "amount",
    "nanoerg",
    "\u00e2\u0080\u009crecipient\u00e2\u0080\u009d",
    "node",
    "look",
    "source",
    "boxoperations.java",
    "sender",
    "input",
    "output",
    "amounttosend",
    "recipient",
    "change",
    "content",
    "guide",
    "idea",
    "parameter",
    "10\u00e2\u0081\u00b9",
    "exception",
    "balance",
    "space",
    "won\u00e2\u0080\u0099t",
    "testnet",
    "mainnet",
    "placeholder",
    "ergopaycontroller.java",
    "mint",
    "token",
    "getreducedsendtx",
    "payment",
    "behalf",
    "thing",
    "detail",
    "reduced",
    "blockchain",
    "good",
    "minter",
    "spender",
    "burner",
    "feature",
    "you\u00e2\u0080\u0099ve",
    "ship",
    "list",
    "ingredient",
    "kind",
    "session",
    "management",
    "backend",
    "chance",
    "shop",
    "item",
    "cart",
    "running",
    "\u00e2\u0080\u009cuuid\u00e2\u0080\u009d",
    "frontend",
    "uuid",
    "p2pk",
    "sessionservice",
    "hashmap",
    "demonstration",
    "purpose",
    "pressure",
    "point",
    "user\u00e2\u0080\u0099s",
    "remember",
    "\u00e2\u0080\u009c#p2pk_address#\u00e2\u0080\u009d",
    "setaddress",
    "call",
    "getuseraddress",
    "desktop",
    "mobile",
    "work",
    "urls",
    "link",
    "github",
    "heroku"
  ],
  "sections": [
    {
      "heading": "What we\u00e2\u0080\u0099ll do in this tutorial#",
      "content": "This tutorial will focus on implementing the backend server-side for ErgoPay, building and preparing transactions. We\u00e2\u0080\u0099ll use Spring Boot to implement a simple ErgoPay REST API. Spring has the following benefits why we\u00e2\u0080\u0099ve chosen it here: It\u00e2\u0080\u0099s JVM-based, and ergo-appkit, one of Ergo\u00e2\u0080\u0099s SDKs, is also JVM-based. It\u00e2\u0080\u0099s easy and boilerplate-free, tons of tutorials and information is available, it runs on your local machine with ease. There are both free and paid services to get the application deployed to the public.\nOf course, you are free to use any other programming language and framework you are experienced with and adapt the concepts outlined here.\nWe won\u00e2\u0080\u0099t cover the implementation of the UI side of your dApp here, but the code of the ErgoPay showcase dApp is open-sourced and of course, you can use it as you wish."
    },
    {
      "heading": "Starting your Spring Boot project#",
      "content": "Spring provides an IDE, but it is not needed so you can work with the IDE of your choice. You\u00e2\u0080\u0099ll also need to have a Java Development Kit installed. If you don\u00e2\u0080\u0099t have one installed yet, use OpenJDK on Linux or install Adoptium on Windows. Head over and generate a fresh Spring Boot project with the initializr. Change the information in the form as you like, for this tutorial you only need to add the \u00e2\u0080\u009cSpring web\u00e2\u0080\u009d dependency. If you don\u00e2\u0080\u0099t use Eclipse I would also recommend switching to \u00e2\u0080\u009cGradle project\u00e2\u0080\u009d. Download and extract the generated project and open it with your IDE.\nYou can start your application with Gradle by typing\n./gradlew bootRun // MacOS/Linux\ngradlew bootRun   // Windows\nThis prints out that the server is running on http://localhost:8080/ now. But as we didn\u00e2\u0080\u0099t do something, it\u00e2\u0080\u0099s not of much use, so you can stop it with Ctrl-C.\nTo get more familiar with how a REST API is implemented using Spring, you should now follow the Spring Quick Start and implement the Hello World endpoint before proceeding here."
    },
    {
      "heading": "Adding an ErgoPay request endpoint#",
      "content": "Now it is time to build your first ErgoPay request endpoint. Such an endpoint is a GET REST API method that returns an \u00e2\u0080\u009cErgoPayResponse\u00e2\u0080\u009d in its response body. ErgoPayResponse is a JSON-based data interchange format between a dApp and a wallet app and is described in Ergo Improvement Proposal 0020.\nAt first, we need to declare this response data type as a Java Object.\nAdd the following file to your Spring Boot project:\npackage org.ergoplatform.ergopay;\n\nimport com.fasterxml.jackson.annotation.JsonInclude;\n\npublic class ErgoPayResponse {\n    @JsonInclude(JsonInclude.Include.NON_NULL)\n    public String message;\n    @JsonInclude(JsonInclude.Include.NON_NULL)\n    public Severity messageSeverity;\n    @JsonInclude(JsonInclude.Include.NON_NULL)\n    public String address;\n    @JsonInclude(JsonInclude.Include.NON_NULL)\n    public String reducedTx;\n    @JsonInclude(JsonInclude.Include.NON_NULL)\n    public String replyTo;\n\n    enum Severity { NONE, INFORMATION, WARNING, ERROR }\n}\nTo send this back as the response body of an endpoint, simply declare this new class as the return type of a RestController method. Spring Boot will automatically handle serialization to JSON format. Such a method could be declared as follows:\n@GetMapping(\"/ergopay/\")\npublic ErgoPayResponse ergoPayError() {\n     ErgoPayResponse response = new ErgoPayResponse();\n     response.messageSeverity = ErgoPayResponse.Severity.ERROR;\n     response.message = \"Nothing implemented yet.\";\n     return response;\n}\nThis is already a valid ErgoPay response and endpoint. It does not serve a transaction, but will only present an error message to the users in their wallet apps.\nIf you start your Spring Boot application now and open http://localhost:8080/ergopay in your local web browser, you\u00e2\u0080\u0099ll see the JSON response in your browser.\nUse the endpoint from the wallet application\nIt\u00e2\u0080\u0099s all good to see the response in your browser, but of course you want to see this in a wallet app. If you have a mobile device with the ..."
    },
    {
      "heading": "Building and reducing a transaction#",
      "content": "The spice of ErgoPay is building a transaction on the dApp side and let the user sign it. For this, ErgoPayResponse has a field \u00e2\u0080\u009creducedTx\u00e2\u0080\u009d. But how to build a transaction and \u00e2\u0080\u009creduce\u00e2\u0080\u009d it? For this, we need to integrate the Ergo SDK into our Spring Boot project. To pull in the SDK, edit the build.gradle file of your Spring project and add the following line in the dependencies section, right below the spring-boot-starter-web dependency declaration:\ndependencies {\n   implementation 'org.springframework.boot:spring-boot-starter-web'\n*  implementation 'org.ergoplatform:ergo-appkit_2.11:4.0.6'\n\n   testImplementation 'org.springframework.boot:spring-boot-starter-test'\n}\nWhen this is done, you can add the following helper method that builds a transaction for sending a certain amount of nanoERG from \u00e2\u0080\u009csender\u00e2\u0080\u009d to \u00e2\u0080\u009crecipient\u00e2\u0080\u009d:\n// This function takes in boolean, long, address of sender and address of recipient\n    // and returns a reduced transaction object.\n    private ReducedTransaction getReducedSendTx(boolean isMainNet, long amountToSend, Address sender, Address recipient) {\n        // Determine the network type\n        NetworkType networkType = isMainNet ? NetworkType.MAINNET : NetworkType.TESTNET;\n        // Create a REST API client with default explorer url\n        return RestApiErgoClient.create(\n                getDefaultNodeUrl(isMainNet),\n                networkType,\n                \"\",\n                RestApiErgoClient.getDefaultExplorerUrl(networkType)\n        ).execute(ctx -> {\n            // Create a new Ergo contract with the recipient's Ergo address\n            ErgoTreeContract contract = new ErgoTreeContract(recipient.getErgoAddress().script());\n            // Create an unsigned transaction to put the given amount of funds to the contract\n            UnsignedTransaction unsignedTransaction = BoxOperations.putToContractTxUnsigned(ctx,\n                    Collections.singletonList(sender),\n                    contract, amountToSend, Collections...."
    },
    {
      "heading": "Going further#",
      "content": "Now it\u00e2\u0080\u0099s time to start experimenting with building other types of transactions.\nAlso check out the ErgoPay example server project \u00e2\u0080\u0094 its ErgoPayController.java file defines some more endpoints: minting tokens, burning tokens, and spending a specific box.\nYou can also just use the getReducedSendTx method to issue payments on behalf of the user to yourself, for example as a payment service. The great thing is that you know the transaction id beforehand: every detail of the transaction is already known when the Reduced Transaction is built, and you can save this transaction id in your backend db and monitor the blockchain to observe when the payment was made to proceed with delivering the goods or services the user paid for.\nYou know enough now to build something like the token minter and box spender of the ErgoPay showcase app. For the token burner, we need one more feature: Connecting a wallet to the dApp UI."
    },
    {
      "heading": "Connect a wallet to your UI#",
      "content": "Connecting a wallet is not needed in general, as you\u00e2\u0080\u0099ve seen: for a payment or minting a token, you don\u00e2\u0080\u0099t need to know the user\u00e2\u0080\u0099s wallet address to collect or validate the data from the user. It is enough to know the address when the transaction is built on request of the wallet app. But for specific use cases, you might need the wallet address more early: The showcase dApp ships a token burner example. For showing the list of owned tokens to choose from, connecting a wallet is needed before the actual transaction is built.\nIndeed, we can obtain the address with all ErgoPay ingredients we already learned about. But we need to introduce some kind of session management on the dApp backend. Chances are high that you already have some kind of session running for the user. For example if your dApp is a web shop, you probably already store the items added to the cart.\nBut if you don\u00e2\u0080\u0099t have any type of session management running, we\u00e2\u0080\u0099ll implement the simplest kind of it now: every user of your dApp has a unique ID (\u00e2\u0080\u009cuuid\u00e2\u0080\u009d) that is randomly chosen by your frontend UI. This uuid is used as a session id. On the backend, we store a user\u00e2\u0080\u0099s P2PK address mapped to this id.\nOur backend needs two API endpoints: one for the wallet app to send a user\u00e2\u0080\u0099s address to store it attached to the uuid, and one for the frontend UI to request if the user address is set.\nThe following two methods do this:\n@GetMapping(\"/getUserAddress/{sessionId}\")\n    public String getUserAddress(@PathVariable String sessionId) {\n        UserData userData = sessionService.getUserData(sessionId);\n\n        return (userData.p2pkAddress != null) ? userData.p2pkAddress : \"\";\n    }\n\n    @GetMapping(\"/setAddress/{sessionId}/{address}\")\n    public ErgoPayResponse setAddress(@PathVariable String sessionId, @PathVariable String address) {\n        UserData userData = sessionService.getUserData(sessionId);\n\n        ErgoPayResponse response = new ErgoPayResponse();\n\n        // check the address\n        try {..."
    },
    {
      "heading": "Your dApp UI on the same device as the wallet app#",
      "content": "We assumed that the user visits your dApp on a desktop and uses the wallet application on mobile, so we only talked about QR codes containing the ErgoPay URLs. This won\u00e2\u0080\u0099t work when users visit your dApp on the same device that the wallet app is running on \u00e2\u0080\u0094 they simply can\u00e2\u0080\u0099t scan a QR code from the same device. Fortunately, you can simply show the ErgoPay URLs as a link for these users. If the user has a compatible wallet app installed, clicking or tapping such a link will open the wallet application processing the ErgoPay request."
    },
    {
      "heading": "Conclusion#",
      "content": "You\u00e2\u0080\u0099ve learned to build an ErgoPay capable backend in this tutorial. You\u00e2\u0080\u0099ll find this as a full example on GitHub. It is also deployed on Heroku, a free hosting service for web apps that you can use to start off with your own projects."
    }
  ],
  "qa_pairs": []
}